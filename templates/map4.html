<!DOCTYPE html>
<html>
<head>
    <title>Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        body {
            display: flex;
            margin: 0;
            height: 100vh;
        }
        #map {
            flex: 1;
            height: 100%;
        }
        #popup-content {
            width: 30%;
            height: 100%;
            padding: 10px;
            overflow-y: auto;
            background-color: #f0f0f0;
            border-left: 1px solid #ccc;
        }

        #slider-container {
            margin-top: 20px;
        }
        #year-inputs {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        #year-inputs input {
            width: 45%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #apply-year-range {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #apply-year-range:hover {
            background-color: #45a049;
        }
        .ui-slider-range {
            background: #4CAF50;
        }
        .ui-slider-handle {
            border-color: #4CAF50;
            background: white;
        }

        #city-select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="map">{{ fmap|safe }}</div>
    <div id="popup-content">
        <h2>Pin Information</h2>
        <div id="details">
            Click on a pin to see details.
        </div>
        <div id="slider-container">
            <label for="year-range">Year range:</label>
            <input type="text" id="year-range" readonly style="border:0; color:#f6931f; font-weight:bold;">
            <div id="slider-range"></div>
            <div id="year-inputs">
                <input type="number" id="min-year" placeholder="Min year">
                <input type="number" id="max-year" placeholder="Max year">
            </div>
            <button id="apply-year-range">Apply</button>
        </div>

        <div id="city-select-container">
            <label for="city-select">Select a city:</label>
            <select id="city-select">
                <option value="">--Select a city--</option>
                {% for city in cities %}
                    {% if city in city_coords %}
                        <option value="{{ city_coords[city] }}">{{ city }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

    </div>

    <script>
        $(document).ready(function() {
            /*
            var map = L.map('map').setView([51.5074, -0.1278], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            */
            var map = L.map('map').setView([51.5074, -0.1278], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            var cityGroup = L.layerGroup().addTo(map);
            var otherGroup = L.layerGroup().addTo(map);

            // 渲染后端传递过来的标记
            var markers = {{ markers | tojson }}
            var markerObjects = [];
            /*以下是根据数量调整marker大小的代码*/
            /*
            markers.forEach(function(marker) {
                var radius = 5 + Math.sqrt(marker.manuscript_count);  // 动态设置半径
                var m = L.circleMarker([marker.lat, marker.long], {
                    radius: radius,
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.6
                });
                m.bindPopup(marker.placename);
                m.on('popupopen', function(e) {
                    $('#details').html(`
                        <h3>${marker.placename}</h3>
                        <p>Place: <a href="${marker.place}" target="_blank">${marker.place}</a></p>
                        <p>Year: ${marker.year}</p>
                        <p>Manuscripts: ${marker.manuscript_count}</p>
                        <p>Latitude: ${e.target.getLatLng().lat}</p>
                        <p>Longitude: ${e.target.getLatLng().lng}</p>
                    `);
                });
                m.on('popupclose', function(e) {
                    $('#details').html('Click on a pin to see details.');
                });
                markerObjects.push({marker: m, year: marker.year});
            });
            */
            /*这是结束的位置*/

            /*标准原始版在这*/
            /*
            markers.forEach(function(marker) {
                var m = L.marker([marker.lat, marker.long]).addTo(map);
                m.bindPopup(marker.placename);

                m.on('popupopen', function(e) {
                    var content = e.target.getPopup().getContent();
                    $('#details').html(`
                        <h3>${content}</h3>
                        <p>Place: <a href="${marker.place}" target="_blank">${marker.place}</a></p>
                        <p>Year: ${marker.year}</p>
                        <p>Latitude: ${e.target.getLatLng().lat}</p>
                        <p>Longitude: ${e.target.getLatLng().lng}</p>
                    `);
                });

                m.on('popupclose', function(e) {
                    $('#details').html('Click on a pin to see details.');
                });
                markerObjects.push({marker: m, year: marker.year});
            });

            */
            /*原始版在这结束*/



            // 渲染后端传递过来的GeoJSON数据
            //var geojsonData = {{ geojson_data | safe }}
                //console.log(geojsonData);
            //L.geoJson(geojsonData, {
                //style: function(feature) {
                    //return {
                        //fillColor: '#'+ md5(feature.properties.name).substring(0, 6),
                        //color: 'green',
                        //weight: 1
                    //};
                //}
            //}).addTo(map);
            markers.forEach(function(marker) {
                var iconSize = [20 + Math.sqrt(marker.manuscript_count) * 2, 20 + Math.sqrt(marker.manuscript_count) * 2];
                var m = L.marker([marker.lat, marker.long], {
                    icon: L.icon({
                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                        iconSize: iconSize,
                        iconAnchor: [iconSize[0] / 2, iconSize[1]],  // 调整图标锚点以使图标底部对齐
                        popupAnchor: [0, -iconSize[1]]
                    })
                });
                m.bindPopup(marker.placename);
                m.on('popupopen', function(e) {
                    $('#details').html(`
                        <h3>${marker.placename}</h3>
                        <p>Place: <a href="${marker.place}" target="_blank">${marker.place}</a></p>
                        <p>Year: ${marker.year}</p>
                        <p>Manuscripts: ${marker.manuscript_count}</p>
                        <p>Latitude: ${e.target.getLatLng().lat}</p>
                        <p>Longitude: ${e.target.getLatLng().lng}</p>

                    `);
                });
                m.on('popupclose', function(e) {
                    $('#details').html('Click on a pin to see details.');
                });
                if (marker.category === 'City/Towns') {
                    m.addTo(cityGroup);
                } else {
                    m.addTo(otherGroup);
                }
                markerObjects.push({marker: m, year: marker.year});
            });


            // 渲染后端传递过来的GeoJSON数据
            var geojsonData = {{ geojson_data | safe }}
            console.log("JSON Data:", geojsonData);

            geojsonData.forEach(function(item) {
                var data = item.data;
                var color = item.color;

                L.geoJson(data, {
                    style: function(feature) {
                        return {
                            fillColor: color || '#'+ md5(feature.properties.name).toString().substring(0, 6), // 使用generate_color_from_string的结果
                            color: 'green',
                            weight: 1
                        };
                    }
                }).addTo(map);
            });

            function filterMarkers(minYear, maxYear) {
                markerObjects.forEach(function(obj) {
                    if (obj.year === "Unknown" || (obj.year >= minYear && obj.year <= maxYear)) {
                        obj.marker.addTo(map);
                    } else {
                        map.removeLayer(obj.marker);
                    }
                });
            }

            // 手动设置滑动条的年份范围
            var minYear = 0;
            var maxYear = 2023;

            $("#slider-range").slider({
                range: true,
                min: minYear,
                max: maxYear,
                values: [minYear, maxYear],
                slide: function(event, ui) {
                    $("#year-range").val(ui.values[0] + " - " + ui.values[1]);
                    filterMarkers(ui.values[0], ui.values[1]);
                }
            });

            $("#year-range").val($("#slider-range").slider("values", 0) + " - " + $("#slider-range").slider("values", 1));

            filterMarkers($("#slider-range").slider("values", 0), $("#slider-range").slider("values", 1));
            $("#apply-year-range").click(function() {
                var minYear = parseInt($("#min-year").val());
                var maxYear = parseInt($("#max-year").val());
                if (!isNaN(minYear) && !isNaN(maxYear) && minYear <= maxYear) {
                    $("#slider-range").slider("values", 0, minYear);
                    $("#slider-range").slider("values", 1, maxYear);
                    $("#year-range").val(minYear + " - " + maxYear);
                    filterMarkers(minYear, maxYear);
                }
            });

            $("#city-select").change(function() {
                var coords = $(this).val();
                if (coords) {
                    coords = coords.split(',');
                    map.setView([parseFloat(coords[0]), parseFloat(coords[1])], 12);
                }
            });

            var baseLayers = {
                "City/Towns": cityGroup,
                "Sites": otherGroup
            };

            L.control.layers(baseLayers).addTo(map);

        });

        // 引入 CryptoJS 库
        function md5(string) {
            return CryptoJS.MD5(string).toString();
        }
    </script>
</body>
</html>
